---
title: 我是怎么读代码的
date: 2022-05-22 17:05:12
tags:
- source code
Categories:
- Others
---

作为一名程序员，总有一些时候，会对自己所做的重复性的工作感到厌倦，也会羡慕明星项目做的热火朝天 star 数蹭蹭上涨。

读一读别人优秀的代码，既能缓解焦虑，又能拓展视野。每当读懂软件的精彩设计，赞叹优美整洁的代码，甚至发现藏在注释中的彩蛋时，都好像在不同的时空与作者产生了交叉，畅快的聊了会儿天。

读代码很有趣，但能读通读懂也很费功夫。本文是笔者在日常读代码中的一点心得，分享出来，希望能与读者产生共鸣。



### 寻找一位好老师

优秀的项目就像一位好老师，我们可以全方位的从它身上学到各种领域的知识。

不过在开始读代码之前， 最大的问题就是：**怎么样找到合适的代码项目**？

star 数高的项目相对更优秀吗？从某些角度讲的确是的，但是在 [gitstar-ranking](https://gitstar-ranking.com/repositories) 上， 4k 个 star 的 repo 只能排到第 5000 名，而至少有 50k 个 star 才有可能排进前一百。光看 star 数，这太多了。

在我看来，通过如下的几个方向来筛选，能选到相对合适的项目：

##### 兴趣使然

首先就是一定要选自己感兴趣领域的项目。

不少代码片段都是比较枯燥而难以阅读的（比如飞一般的位操作，为提升性能而莫名其妙的语句，或是包含了大量隐含知识等等），只有自己感兴趣，才会有读下去的意愿和动力，才能在其中发现乐趣。

有时候我们开始读代码的契机就单纯是在工作当中用到了，想要进一步了解其原理和设计，这是一个不错的起点。想必很多同学第一次看源码都是因为一层层追到了 Spring 的 class 里面去吧。

有的时候可能就是觉得某项技术很神奇，像魔法一样，很想了解它是怎么施法的。（我就是因为觉得神奇所以去看了 kubelet 的代码）

总之一旦有了兴趣，就会很像进一步了解它。但如果读到一半又失去了兴趣，也请大胆的放弃它。失去了这一片草丛，还有整个树林等着我们去探索。



##### 经典且被大量使用

经典的、拥有大量用户的项目，经历了时间的考验，不断的迭代，通常在设计上都有很多出众之处。

经典项目的维护者一般都是非常资深的工程师，并且也都会有大公司赞助，确保了代码的高质量。这类项目在阅读的过程中能学到很多知识，例如架构抽象、性能优化、工程化等等。

这类典型的项目就如：Go、Linux、MySQL。K8S 等等。



##### 合适的规模

代码量太过庞大的项目，虽然很经典，但难免令人生畏。

实际上可以找到很多规模不大，但依然完整实现设计思想的项目。

首先就是各种语言的标准库，比如 Java 的 Stream、AQS 等等。另外也有许多开源的规模不大的优秀项目，比如 redis、leveldb 等。另外，许多经典大学课程里面的 Lab 也隐藏着优秀的项目，比如 xv6。

总之，这一类代码可能几天或几周就能大致看完主干，特别适合学习设计思想。



### 先读文档

选定了项目，我们一定已经对它做了什么事以及最基本的概念和原理有浅尝辄止的了解了。

这时候，尽量不要直接clone 代码开始阅读。通常对于事物的理解，从全局到部分，从抽象到细节是一个比较容易让人接受的过程。

代码的特点就是事无巨细的包含了所有知识，但也将细节毫无保留的暴露出来，直接进到代码容易迷失方向。



##### 了解概览

成熟的项目通常会有比较详尽的文档，文档一般分两类：给用户看的使用文档，和给贡献者看的开发文档。

通过阅读使用文档我们能快速的了解到项目创立的目的、解决了哪些问题，以及从用户的视角看该软件是什么样子的。除了看 overview，我也会大致的关注配置，通过必填配置可以进一步的了解软件的依赖和外部特性。



##### 架构和模块

优秀的开发文档一定会包括整个软件的架构模型，和关键模块的设计。

通过阅读架构图和高层设计，软件的原理或到底是采用什么方式来解决问题的会一目了然。对于有一定经验的读者甚至可能看到架构设计后就已经能大概知道软件的工作流程了。

除了架构设计，比较完善的开发文档也会包含关键模块的设计。关键模块可能会包含核心逻辑的设计和数据结构，以及边界处的契约和交互方式。

（举例子比如 leveldb 的文件模型）

搞明白了架构模型和关键模块，真正打开源码时就会将包、文件名、接口等等包含的知识与整体结构相互映射，在脑中形成一张完整的图。



##### 其他的前置知识

有时候文档的作者还会添加不少前置知识，比如基于什么样的算法，受到了哪些知识的启发甚至是实现了哪篇论文的思想等等。

如果能有这些前置知识，对我们的理解会大有帮助。因为我们可以通过学习这些知识来进一步了解软件的细节设计。



### 再读代码

看完了文档，就可以开始看代码了。为了防止在代码中迷失方向，我们可以遵循几条规则来阅读：

##### 从入口开始

虽说通过架构模型和包、文件划分的关系，我们能大致确定哪些代码是核心代码，但从入口处开始看会更符合大脑的思考方式。

因为入口代码的工作一般是先对各种模块进行初始化，然后调起主线程或者启动主服务，这种明确顺序的简单工作让我们不会一开始就遇到困难，会对大脑产生奖励。



##### 抓住主线，从抽象到实现

主线就是从输入是怎么样一步步产生输出的。在这一过程中，会涉及到多个模块，每一个模块又有自己的输入和输出。

当我们顺着函数调用、数据传输一步步向下时，随着抽象层次的不断降低，涉及到越来越多的细节，这个时候应该及时的返回去，不要一路看到底，容易陷入细节。

良好的设计会有合理的抽象，根据不同的开发语言，我们可以通过查看包、接口、特性，公有方法列表、头文件等等来快速获取抽象信息，逐步的拼接出程序主线。之后再将抽象展开后阅读实现代码。



##### 一边阅读一边记录

作为一个项目的初学者，随着阅读的深入，很可能前面看过的东西过段时间就忘记了，因此一边读一边记是很重要的。

可以适当的画一画模块，记录具体的函数名，帮助大脑快速回忆。

在看的过程中，不明白的细节，或者需要拓展的知识，也可以记录下来，找其他时间深入学习。



### 写篇文章讲讲整个设计

代码看个七七八八，差不多就对设计和实现都有一定的认识了。这时候心里多少会有点冲动想要把获得的知识讲出来。这时候最好就是篇文章，一方面对知识进行梳理，在写的过程中也会不断加深印象，从知道怎么实现，上升到软件作者为什么会这么设计。

##### 整理大纲

写文章，目录最关键。一篇文章是不是有逻辑性，结构是不是清晰，全都在大纲的设计上。

既然我们的内容是讲软件的设计与实现，那么文章的大纲就可以按 why - what - how 来展开：先告诉读者为什么要设计该软件，之后像官方文档一样讲述软件的架构模型和关键模块以及主线流程。最后详细的讲解具体实现。



##### 描述设计原理，通过画图帮助分析设计意图

在写文章之初，我们的知识还不够深入和整体，可以先写 what 和 how 的部分，加深理解之后，就能明白设计的 why。

在介绍原理和实现的时候，相比与贴代码，更好的方式是通过画图来表达。代码可以提现作者的设计意图，但代码更重要的任务是作为知识和硬件指令之间的桥梁。相反，当我们用图表的形式表达设计意图，会对读者更友好，更容易理解和学习。

画图本身也是一种加深理解，去粗取精的过程。



##### 想一想，为什么要这么设计，好处在哪里？

当我们能用图表和文字表达出来软件的完整设计后，我们对代码的理解已经比较透彻，甚至，让我们自己来照着写一个新的也不是不可能了。

这个时候，就应该进一步的思考，如果是我自己来解决问题，我会怎么做？我会比原作者做得更好吗（通常不会）？

经过这一类思考，再结合了解业内其他类似的解决方案，我们就能清楚的认识到，问题的限制条件是什么，作者这样设计的好处有哪些。

把这部分写完，添加到文章的最开始，就比较完美了。



（如何技术写作）



### 讲个 session 可以带来额外的 bonus

如果有足够的精力和时间，能把文章转化成给一个 session，讲给大家，则一定能获得额外的奖励。

##### 梳理要点，逻辑自洽

一个 session 讲的好不好，关键是能不能逻辑自洽。而逻辑自洽的前提就是关键点要清晰，并且前后可以呼应。

在整理 session 材料的过程中，我们会反复的遍历整个文章，以图能理顺逻辑，这个过程经常伴随着对文章的进一步修改，直至自洽。当整个 slide 能完整的顺下来时，成就感爆棚。



##### 去粗取精，锻炼表达

相比写文章，讲 session 要我们进一步的去除细节，只保留最核心的设计思想，这本身是对抽象能力的一种锻炼。

另外，自己了解清楚，和能给别人讲清楚是完全不同的两种概念。如何能把核心知识讲给听众，并且能让听众更容易的听懂，需要仔细的思考语言的表达。每一次成功的 session 都是对自己表达能力的一次提升。



##### 揣摩听众感兴趣的方向

要做演讲，考虑听众的感受也很重要，如果讲的内容听众不感兴趣，不爱听，或是晦涩难懂，听众跟不上，都会导致整个 session 反响寥寥，大家会觉得来听你的 session 浪费了自己的时间。

所以不仅要能讲清楚，还要揣摩听众感兴趣的方向。合理的设置内容，去除枯燥乏味而非关键性的东西，并且调整讲解的顺序，把易懂的、精彩的部分穿插放置，就可以不断地激发听众的兴趣。



##### 尽可能的贴近观众

线下 session 的效果要比视频 session 好得多。在线下听众的注意力更集中，演讲者也更容易通过听众的表情、神态来判断是否需要调整内容和速度。如果条件限制一定要做视频 session，那么可能需要经常停顿下来问些问题，或是主动的寻求反馈。



### 结语

本文是我日常读代码的一点经验，总结下来，就是要

- 仔细的选择学习的项目
- 先通过文档了解全景，再逐步深入代码
- 找对抽象和边界，能帮助我们建立思考模型
- 写篇文章讲述代码的设计，是深入理解代码的好办法
- 自己学会了还不够，能清楚地讲给别人才是真正的掌握

