---
title: TiDB 学习课程 Lesson-7
date: 2020-10-12 22:26:46
tags:
- tidb
categories:
- TiDB
---
本节课程主要学习的是 TiDB 的 事务原理。由于 TiDB 的分布式部署的特性，其事务的实现主要借鉴了 [Percolator](https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36726.pdf) 中分布式事务的实现方式，将 TiDB 与 TiKV 结合起来，共同完成分布式事务的任务。

> 本文中涉及到的图片来源，都来自 PingCAP 官方网站。

<!-- more -->

## TiDB 事务

我们已经知道，TiKV 基于 k-v 实现了数据的存储，MVCC 层暴露了带版本的 k-v 的操作。而在 MVCC 层以下对每一个 kv pair 的一致性复制，采用 raft 实现。

所以，当一组操作涉及到了对多个 kv pair 的读写时，就需要采用事务来确保这组操作的完整性。另外需要注意的是，被操作数据很有可能分布在多个 TiKV 节点上，那么就要求事务是分布式事务，能够确保跨节点操作的一致性。

### kv pair 之间的事务

设想假如只有单个 TiKV 节点，一组操作中涉及到的所有数据都限定在单节点中，那么事物的实现就可以简化对每一个涉及到的 kv pair 进行加锁，处理完之后，在提交时统一解锁就可以了。

扩展到分布式事务场景下，实际上我们也可以照搬加锁后提交的逻辑过程，只是在分布的节点中可能遇到许多不可控的因素来打破我们提交流程：

- 由于网络通信的原因，导致一部分 key 提交成功，一部分 key 没收到提交请求
- 由于不满足约束条件，导致满足约束的节点提交成功，而不满足约束条件的节点提交失败
- 由于节点故障，某个节点失去响应，导致涉及到该节点的数据提交失败

一旦发生上述情况，就会导致事务内的数据出现了部分提交，破坏了一致性。

由于我们无法确保上述现象一定不会发生，那么就只能加固提交的过程来规避这些问题。

既然部分 key 有可能因为种种原因无法成功提交，那么不如这样：

1. 大家都先不要提交，而是增加一个准备阶段，发起者向每个节点发送准备请求，要求节点准备好要提交的数据，并等待发号施令
2. 所有节点准备好数据后，都回复发起者说，我这里一切就绪了。假如在这一阶段发生了上述的问题，那么因为所有数据都还没有被提交，因此就不会破坏一致性
3. 发起者汇总了大家都准备好的信息后，一声令下，全都提交，这时所有节点都在收到命令后开始提交流程。

假如在提交阶段发生了上述问题，那么相应的节点会尽最大努力尝试提交。例如某节点在准备完成后，一直没有收到提交命令，此时他可能会采取继续等待，或与其他节点沟通等等策略。而由于不论是发起者发送请求之前，还是节点接收到请求之后，都会先记录日志（WAF），因此假如在提交过程中宕机，恢复后可以继续执行原来的操作。

## 乐观事务实现

## 悲观事务实现

