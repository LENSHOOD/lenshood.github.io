---
title: 关于浮点数与 IEEE 754
date: 2019-06-20 23:20:43
tags:
	- float
	- ieee754
category:
	- java
---

由于某些神秘的原因，某些理所当然的数值计算，通过编程语言操作时，会让人匪夷所思。

来看一个 Java 的例子：

``` java
@Test
public void floatCalculationTest() {
    System.out.println("a=" + 1.0f);
    System.out.println("b=" + 0.9f);
    System.out.println("a-b=" + (1.0f - 0.9f));
}
```

执行结束后，控制台会显示什么？

执行结果：

``` shell
a=1.0
b=0.9
c=0.8
a-b=0.100000024
b-c=0.099999964
```

单个数字拎出来打印都正常，但是运算后出现了很小的误差。这种情况在 JavaScript 中也很常见，我们经常会发现在 js 里做一些简单运算的时候不是我们想要的结果。

这一切的锅，都应该由 [IEEE 754](https://en.wikipedia.org/wiki/IEEE_754) 来背。

### 什么是 IEEE 754
在 long long ago，计算机还没有普及的年代，采用计算机进行浮点数运算，由于没有统一的标准，因此各家有各家自己的实现方法，导致兼容性差，也不可靠。鉴于此，IEEE (我读 I triple E) 在 1985 年，提出了一种浮点数存储、运算的标准，来规范计算机的浮点运算，这项标准的编号即为 IEEE 754。后来 IEEE 754 被写入了 ANSI 标准，因此绝大多数计算机都支持该标准。

那么 IEEE 754 究竟定义了些什么呢？

最简单的一句话，IEEE 754 定义了：**在计算机中浮点数应采用科学计数法的形式，存储于固定长度的存储单元中。**

#### 存储格式
IEEE 754 中规定了三种二进制浮点数的样式，分别对应了 32bit、64bit、128bit 长度的编码。目前最常用的两种即：
- single float 单精度浮点数，32bit
- double float 双精度浮点数，64bit
这两种格式的编码结构如下：
{% asset_img float-format.png %}

可见，在存储格式上，规范采用了 \[符号位\] \[指数位\] \[小数位\] 三部分来表示，其中
- single float 包括 8bit 指数位和 23bit 小数位
- double float 包括 11bit 指数位和 52bit 小数位

#### 换算方法
IEEE 754 采用科学计数法来表示浮点数，其换算过程通常分为两步：
1. 将十进制数转换为二进制数：
	- 整数部分直接转为二进制
	- 小数部分在转换无法收敛时选取适当长度进行截断
2. 对上一步的二进制数进行规范化(Normalized)
	- 对小数点进行移位，以确保二进制数按照科学计数法：`1.xxxxx * 2^n` 的形式表示。
	- 将科学计数法中的指数位 n 取出，作为存储格式中第二部分，为了避免考虑 n 存在正负值的情况，实际写入时给 n 加一个偏移量，单精度浮点数偏移量为 127，双精度浮点数偏移量为 1023。

以下举例说明上述转换过程：

