---
title: Kubernetes 多集群的发展与趋势
date: 2023-02-07 20:33:21
tags:
- multi-cluster
- multi-cloud
- k8s
categories:
- Kubernetes
---

{% asset_img header.jpg 500 %}

本文介绍了 K8s 多集群的由来以及实现多集群所面临的核心问题，之后分析并探讨了现有的 K8s 多集群方案，最后根据目前实现方案的痛点与挑战，设想了未来的演进趋势。

<!-- more -->

## 为什么需要 K8s 多集群？

在探讨为什么需要 K8s 多集群之前，我们首先定义一下什么是 K8s 多集群：

所谓 K8s 多集群，顾名思义就是多个 K8s 集群，组织可根据自身需求，例如为了满足隔离性、可用性、合规性或使用成本等，将其应用程序运行在任意一个或多个集群中。此外，在更加成熟的 K8s 多集群中，应用程序实际运行的集群能够动态配置，不同集群间的应用程序也应该支持相互访问。

定义讲完，我们会发现，多集群的概念是被 K8s 限定的，那么问题来了：

### 在 K8s 之前，还存在多集群吗？

不论 K8s 是否存在，对应用的隔离性、可用性、合规性或使用成本等需求是持续存在的，因此我们总能听到企业购买或构建的所谓云管平台或称多云管理平台（架构如下图所示）。云管平台正是为了满足企业对应用部署的复杂需求，对接各种不同公/私有云的 API，并尝试对云资源进行抽象，进而尝试将应用运行所需的环境与真实云资源解耦。

![](http://cds.chinadaily.com.cn/dams/capital/image/202205/31/6295b81ae4b013b65bf3ff36.jpg)

然而，由于各种云提供商的 API 都不尽相同，云管平台的主要工作更多的是做 API 集成，并且每多一种云，就需要进行一次集成（Terraform Provider 的出现极大的缓解了这一问题）。随着企业逐步依赖在云管平台上交付应用，也就逐步依赖了云管平台的厂商。

回到现在。在 K8s 为云原生应用提供了统一交付体验的同时，也很大程度上消除了云管平台集成 API 的苦力活。如果企业没有太过复杂的动态调度需求，只需要在每个云上部署一套 K8s，应用就很容易通过原有的流水线在不同云的 K8s 上进行交付。

因此，**K8s 多集群的主要应用场景就是：多云适配。**

### 多集群的应用场景

虽然不同企业面临的问题不同，对应用交付的需求也不同，但总体来看可能存在以下几种多集群的常见应用场景：

**隔离性**：在多租户隔离，开发/测试/生产环境隔离，地区合规性隔离等场景下，相互隔离的应用部署在相互隔离的 K8s 集群中。

**高可用与故障转移**：为了保证应用的高可用性，当主集群出现严重故障时，集群上运行的应用能够迁移至备用集群。集群之间可以互为主备，并通过接入不同云厂商来降低风险。

**单集群规模**：在某些大规模场景下，单集群节点数逐步到达上限，集群控制面性能成为瓶颈，将大集群拆分为小集群可以缓解集群性能问题。

**弹性突发**：将集群也视为弹性资源，在非业务高峰期，应用运行在成本更低的私有云上，一旦出现业务高峰，私有云资源不足时，可以快速在公有云创建集群并调度应用副本，高峰过后再销毁。

**地理亲和性**：顾名思义，应用部署在多个集群上，而不同集群处于不同的地理位置，这样就能将用户请求根据实际发出的位置，路由到距离最近的应用上。

总结上述场景，落地 K8s 多集群，不外乎是通过赋予业务应用更灵活的弹性，而实现业务的安全性、高可用性与可迁移性，若能叠加集群本身的弹性，则可以真正做到云原生的所谓 ”无限资源“。



## 实现多集群管理的核心问题

上一节介绍了企业对多集群需求的现实性，假如企业已经决定开始尝试采纳多集群技术，那么势必会面临多集群的管理问题。

对于多集群的管理，存在哪些现实问题需要解决呢？这一节我们就来讨论实现多集群管理需要解决的核心问题。

### 跨集群应用调度

多集群的本质上是为了让应用运行在更合适的位置。应用到底运行在哪里，要考虑的决策点可以有很多，例如高可用、成本、合规性、地理位置等等。因此多集群管理中首先要解决的问题就是，跨集群应用该如何灵活的进行调度。

实现跨集群调度的方式有很多，最简单的，可以将不同应用需要运行的位置提前定好，随着 CI/CD 流水线的发布，应用自然而然就运行好了。当然了这种调度策略属于一种全静态的人工调度，能用但不够灵活。

就像 K8s 一样，自动化且灵活的调度，依赖运行在集群内的调度器软件，多集群管理也需要考虑设计自动化的调度器。

如下图所示，不同领域的调度器，其调度模型实际上是高度一致的：

{% asset_img logical-sched.png %}

调度的过程就是根据一定规则为任务分配资源。这里涉及到三个概念：任务，资源，规则。在多集群管理的语境下，任务就是应用，资源就是集群，而规则是一系列能够影响调度器决策的的调度策略。应用与集群属于既有系统中的概念，因此设计跨集群应用调度器，调度策略是核心。

#### 调度策略

通过调度策略，我们期望能解决 ”什么样的应用” 需要被调度到 “哪类集群” 的问题。显然，应用有其自身独特的属性集，集群也一样。从属性集的角度看，调度策略问题就可以转化为应用与集群属性集之间的最优匹配问题。

--------------- 图

举例说明，应用的属性集可能包括：命名空间、资源依赖、副本数、镜像名、租户归属、应用亲和性/反亲和性、最小资源需求等等，集群的属性集可能包括 AZ、地区（Region）、节点数、已分配 Pod 数、资源总量/余量、污点（Taint）等等。

基于上述属性集的的匹配策略可能包括：

- 应用的命名空间必须与集群一致
- 应用需要与亲和性应用绑定在同一个集群
- 有污点的集群不接受新应用
- 多个集群满足要求则平均分配副本
- 部署偏好尽可能平衡集群间的资源
- 高优先级的应用可以抢占低优先级的应用
- 有状态应用必须先调度数据

借鉴 K8s 的调度实现模型，上述每一种匹配策略都可作为一种决策器，通过检查它所关注的属性来做出调度决策。而决策器又可分为过滤型和打分型，过滤型决策器给出成功或失败的决策结果，打分型决策器给出分数。

进行调度决策时，待调度应用与待选集群的属性集依次通过所有过滤型决策器和打分型决策器，最终找到一个（或一组，考虑多副本高可用）分数最高的集群，调度完成。

### 跨集群信息互通

1. 网络连通性
2. 服务发现与治理
3. 控制信息同步

### 应用资源模型

1. 如何定义应用资源
2. 原生 API 兼容性
3. 扩展：配置 contrains，调度 hint

### 集群即资源

1. 生命周期管理
2. 资源特性与配额（如云和边资源特性差异）
3. 认证鉴权与资源隔离性（多租户属于上层容器平台的范畴）

## 几种方案对比

### Karmada

### OCM

### Rancher

### KubeFed V2

## 演进趋势

1. 真的需要扁平网络吗？（跨集群 pod 同一个网络）
2. 跨集群方案怎么解决数据同步问题
2. 如何统一管理传统云资源，如 VM，块存储，VPC 等
