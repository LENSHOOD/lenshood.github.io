---
title: 构建可伸缩的平台工程软件栈架构
date: 2023-05-09 22:08:49
tags: 
- multi-runtime
- platform engineering
- multi-cluster
- multi-cloud
categories:
- Software Engineering
---

## 平台工程是新概念吗？

[平台工程（Platform Engineering）](https://platformengineering.org/blog/what-is-platform-engineering)，是通过为企业内部研发人员提供一整套工具链和资源以及知识，来更好的为研发人员构建工作流，以使研发团队在 DevOps 实践上更易于达成 [DORA Metrics](https://cloud.google.com/blog/products/devops-sre/using-the-four-keys-to-measure-your-devops-performance) 所描绘的高效能团队要求。

平台工程在企业内部一般是通过 IDP 内部开发者平台（Internal Developer Platforms）来落地实现。通过 IDP，研发人员能够方便灵活的对业务应用进行研发和交付，而不必将大量时间花费在学习和使用交付工作流所依赖的各种底层设施。而企业通过构建小规模的[平台工程团队](https://www.thoughtworks.com/zh-cn/radar/techniques/platform-engineering-product-teams)，开发并维护内部开发者平台，就能服务数倍于该团队人数的业务研发团队。

实际上，很多人在了解到平台工程这一概念后，都会心生疑惑：“平台工程是个新概念吗，听着耳熟啊？”，“这不就是我们公司的 xxx 平台吗？ （这里的 xxx 可能是 **研发管理平台** / **DevOps 平台** / **开发者平台** / **一站式运维平台** 等等”。

的确，至少在笔者所经历过的雇主、客户等诸多场景中，就接触过（甚至咨询过）不下 5 个类似的平台，虽然它们的名称、内部编号各不相同，但全都至少会提供包括代码仓、CI/CD 流水线、配置中心、制品库、资产管理、APM、日志监控、链路追踪等基础能力。通过这些能力，业务研发团队可以相对简单和方便的将业务交付到生产。

### 真实企业的 DevOps

参考 2018 年由信通院组织起草的[《研发运营一体化（DevOps）能力成熟度模型》](https://hbba.sacinfo.org.cn/stdDetail/12bebc74402d9eced9cc0440ef6e4f879c11718e5df86101f985255fb24c35e0)，定义了：

> 研发运营一体化是指在 IT软件及相关服务的研发及交付过程中，将应用的需求、开发、测试、部署和运营统一起来，基于整个组织的协作和应用架构的优化，实现敏捷开发、持续交付和应用运营的无缝集成。

并且基于此进一步描述了 DevOps 在敏捷开发管理、持续交付和技术运营几个子项下对企业能力的要求。并通过一个成熟度模型来评估不同企业 DevOps 能力所处的阶段。

{% asset_img YDT-3763.png %}

显然 DevOps 能力的建设并不是只要通过几个工具组合起来就能落地的实践，而是一整套涉及管理、流程、工具和文化的体系化工程和变革。

许多企业没有精力和人才来构建整个 DevOps 体系，就只好先从便宜且收效快的地方入手：找原来的运维团队抽调几个人，采用开源方案搭建内部的代码仓（如 GitLab）和流水线（如 Jenkins），再手写一些通用的脚本来实现基础的制品部署。能有更多投入的企业，还会建设一些需求管理工具、资产管理工具等（对接云服务提供商的 API）。

<img src="https://kubesphere.io/images/devops/dev-ops.png" style="zoom: 67%;" />

但在业务开发团队的视角下，这些与 DevOps 相关的工作似乎还是 Tech Lead 或者专职 DevOps（是的，真有这一岗位）的职责。究其原因仍然是普通开发人员玩不转或者根本不想考虑代码到底如何才能交付上线。

上述实际情况大量存在于各类企业，这与 “You build it, you run it” 的 DevOps 精神是完全相悖的。此外由于与 DevOps 相关的工作通产会被代理给更资深的人员，因此他们的时间也被明显的侵占了。而随着云原生的不断发展，各类新的概念和实践被提出，研发人员愈发的感觉到知识追赶的压力，也就越来越抵触做 DevOps 相关的事情。

{% asset_img cncf-landscape.png %}

真正具备了高 DevOps 成熟度的企业，有如下两种不同的实践：

1. 团队自组织的 DevOps 实践：完全开放的独立式团队，由成熟的研发人员组成，践行敏捷文化，根据实际情况自建或选择工具链（如 Github Actions），通过 IaC 确保流程和基础设施全部代码化管理，自主选择构建配置管理、Key 管理、可观测性等能力的方案。
2. 企业统一构建成熟的内部开发者平台：通过在企业内部搭建非常完善的平台、工具甚至基础设施，推行全公司一致的研发流程和团队管理实践，并通过构建复杂的指标体系来评估不同的研发团队并与绩效挂钩，自上而下的推动 DevOps 能力的提升。

上述两种不同的实践中，第一类更适合分散作战的小型精英团队，能快速且成本可控的交付软件。而对于第二类实践，其建设投入非常可观，更适合大型企业。事实上很多大型企业自建的内部开发者平台，已经和平台工程的概念内容逐步趋同了。



## 平台工程能力的演进

前面提到，许多企业都可能期望通过构建一定的工具和平台来弥补其 DevOps 能力的欠缺，不同的投入水平会得到不同的效果。而大型企业在经过持续的投入和演进后，也已经构建了趋近于平台工程概念所描绘的 IDP。

在 CNCF App Delivery TAG 发布的 [*平台工程白皮书 Platforms White Paper*](https://tag-app-delivery.cncf.io/whitepapers/platforms/) 中，对企业平台工程能力的成熟度做了总结（成熟度由低到高）：

>1. 产品开发人员可以根据需要配置相关能力，并立即使用这些能力来运行系统，如计算、存储、数据库或身份认证。
>2. 产品开发人员可以根据需要配置服务空间，并在服务空间中运行流水线和任务，来保存制品和配置，以及收集遥测数据。
>3. 第三方软件的管理员可以按需配置依赖，如数据库等，并轻松安装和运行该依赖软件。
>4. 产品开发人员可以通过模板（templates）配置完整的环境，这些模板结合了专用场景（如web开发或MLOps）下所需的运行时（run-time）和开发时（development-time）服务。
>5. 产品开发人员和管理人员可以通过自动数据采集和标准看板来观测已部署服务的功能、性能和成本。

可以看出，按成熟度模型的划分，IDP 所能提供的能力从基础到高级可归纳为*「基础设施 -> CICD -> 自助 PaaS -> 模板自动化 -> 可观测」* 当然，以上的一切都是云原生的。

基于以上能力，白皮书描绘了平台工程的能力图谱，以及其所处的位置，即处于产品应用团队与能力服务提供者之间：

<img src="https://tag-app-delivery.cncf.io/whitepapers/platforms/assets/platform_components.png" style="zoom: 67%;" />

#### 企业诉求的变化

企业在不同的规模和发展阶段下，对平台工程所能提供的能力，以及 IDP 建设的成本的诉求，可能是大相径庭的。

纵然在这篇 [*何为平台工程*](https://platformengineering.org/blog/what-is-platform-engineering) 中提到，只要组织规模达到 20~30 人，就可以开始关注 IDP 了。但小规模企业对平台工程能力建设的主要考量点可能还是**基本可用**和**成本最低**。通过尽量使用便宜的甚至免费的服务来满足 DevOps 的要求就是最好的选择，因此小规模企业可能更容易接受 SaaS 化的解决方案，例如云提供商打包出售的开发者服务，或者类似 [Github Pro](https://github.com/pricing)、[Coding](https://coding.net/) 等方案。

而当企业达到一定规模，并且处于高速发展期时，其诉求可能变化为更关注软件交付的速度，以及 IDP 的快速扩展能力。毕竟高速发展的业务需要平台成支撑其快速试错、快速占领市场的目标，同时大量扩张的业务和用户量也要求 IDP 能更快、更简单的扩展新功能以支持业务发展。

大规模企业在平台工程能力的建设上，就更倾向于要求易用、合规、稳定、并且能降本增效。为了支撑大型企业中各式各样的业务需求，IDP 在用户交互上需要简明易用，降低学习门槛。而由于存在跨国跨地区的业务，以及内部用户众多，合规性和稳定性的要求也非常重要，IDP 可以没有存在感，但不能因为 IDP 而导致企业发生损失。最后，大规模企业流程多、效率差，降本增效是持续的主题，IDP 需要尽可能的自助化、傻瓜化从而降低人员使用成本，提升效率。

因此，企业对平台工程能力建设的诉求，在不同规模下不同，在不同时期下也不同。那么在设计 IDP 的整体架构时，如何才能满足不同的诉求呢？采用可伸缩、模块堆叠的软件栈架构是一种可行的办法。



## 可扩展的软件栈架构

软件栈（或称[解决方案栈](https://en.wikipedia.org/wiki/Solution_stack)）是通过一组软件子系统或组件来构建的一个完整平台，在该平台之上可以运行特定的应用程序。这种基于抽象分层的栈模式在软件系统中十分常见。

一个简单的 Web 服务就可以是一种软件栈，其包含的组件有 Web 服务器、数据库、容器、文件系统、网络栈、硬件驱动等，它们分别处于不同的抽象层次，由不同的人开发和维护，通过标准化接口进行通信和交互。

对于前面所提到的构建平台工程能力过程中，将企业需要自研的部分尽可能收敛和内聚，通过设计标准抽象层，并尽可能借助开源社区的力量，构建分层的、可扩展的、组件化的软件栈架构，就能够充分应对平台工程能力建设在成本和功能上多变的场景化诉求。

基于上述思想构建的可扩展的平台工程架构，如下图所示：



可见，设计自上而下的抽象层，在层内组合多种组件，就可以搭建起灵活的平台工程架构。

### 可扩展的能力抽象层

作为平台架构的最上层，能力抽象层的目标是通过提供合理的抽象与接口，让应用在开发态和运行态都能更关注于业务本身，而将运维能力侧和公共组件侧的需求尽可能代理出去。

#### 统一应用模型

通常意义上，应用在 Day2 阶段的持续时间要远大于 Day0 和 Day1，这也就导致了交付和运维的工作是繁杂和冗长的。软件部署早已不是把包丢到服务器上然后启动进程就完事，还包括配置管理、服务拓扑、副本扩缩、流量分发、监控、审计、成本优化等等各种要求。

为了满足这些要求，需要通过各种工具和手段来实现，而正如前文提到的，很多开发者可能并不想去了解这些玩意儿到底如何使用。毕竟作为应用开发者，他们更清楚自己软件的入口是`/index`，而不清楚从主域名经过几层 Nginx 才能路由到到`/index`。

通过定义一套标准的应用交付模型，就可以将应用开发团队和平台团队的关注点进行分离，由开发者定义特定应用在交付和运行中的需求，由平台团队来实现这些需求。

[OAM（Open Application Model](https://github.com/oam-dev/spec/blob/master/README.md)就是这样的一种模型标准。

<img src="https://github.com/oam-dev/spec/blob/master/assets/overview.png?raw=true" style="zoom: 50%;" />

平台团队提供 ComponentDefinition 来描述不同应用的部署模型，如`通过 K8s Deployment 部署的无状态后端服务`，`直接推送 CDN 的静态前端页面` 等。应用开发者只需挑选某个 Component 来描述应用，并设置一些属性参数，如镜像名、ENV、端口号等等即可。

同时，平台团队还提供了对 Traits 和 Scopes 的定义，这允许开发者为他们的应用添加运维特征如动态扩缩，灰度发布，负载均衡等，以及分组特征如安全组，AZ等。

因此，开发者只需要将应用模型以类似 `yaml` 的形式维护在代码仓内，随着 [GitOps](https://www.weave.works/blog/what-is-gitops-really) 流程，应用就会顺滑的交付上线。

> [Kubevela]([kubevela.io](https://kubevela.io/)) 实现并扩展了 OAM。

#### 分布式能力抽象

在成规模的服务化体系中，应用可能依赖了越来越多的中间件以及三方服务，它们提供了应用实现业务目标所需要的各种分布式能力。然而，传统的 SDK 集成方式让这些分布式能力变成了一个个的孤岛，难以统一治理，导致维护困难、升级困难，降低了整体的研发效率。

平台可以将各种分布式能力进行归类和抽象，为应用提供统一的分布式能力抽象层，因而应用只需要通过抽象层调用标准化能力，由平台团队维护实际的能力实现组件。

[多运行时架构](https://www.lenshood.dev/2022/12/06/multi-runtime/)就是基于上述思想提出的解决方案：

<img src="https://www.lenshood.dev/2022/12/06/multi-runtime/3.webp" style="zoom:67%;" />

多运行时架构的理念，是将各种分布式能力归纳为 4 个部分：生命周期、网络、状态以及绑定。传统场景下，这四大能力是由各类基础设施和中间件来提供的。

<img src="https://www.lenshood.dev/2022/12/06/multi-runtime/7.png" style="zoom:50%;" />

通过`Mircologic + Mecha`，即微业务与所谓“机甲”相组合的方式，将业务对分布式能力的需求全部交给 Mecha 运行时来代理，而真实提供分布式能力的组件，通过 Mecha 与业务应用隔离。

平台通过为每一个业务应用提供 Mecha 运行时，隔离需求与实现，因此能够方便的对各种中间件进行维护和扩展。

> 多运行时架构的实现方案有 [Dapr](https://dapr.io/)、[Layotto](https://mosn.io/layotto/#/zh/README) 等等



###可扩展的 DevOps 组件层

1. CI/CD
2. 应用生命周期
3. 安全
4. IaC
5. 可观测性



### 可扩展的资源编排层

1. 跨集群
2. 动态调度
3. 资源抽象
4. 灵活网络
5. 集群标准化
6. 集群即资源



### 可扩展的基础设施层

1. 多云适配
2. 混合云
