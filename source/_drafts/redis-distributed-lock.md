---
title:  Java 基于 Redis 实现分布式锁需要注意什么？
date: 2020-02-04 23:13:16
tags: 
- distributed lock
- redis
categories:
- Java
---

在如今这样一个张口分布式，闭口微服务的软件开发趋势下，多实例似乎已经不是某种选择而是一个无需多说的基本技术要求了。

多实例为我们带来稳定性提升的同时，也伴随着更复杂的技术要求，原先在本地即可处理的问题，全部扩展为分布式问题，其中就包含我们今天会聊到的多实例同步即分布式锁问题。JDK 提供的锁实现已经能够非常好的解决本地同步问题，而扩展到多实例环境下，Redis、ZooKeeper 等优秀的实现也使得我们使用分布式锁变得更加简单。

其实对于分布式锁的原理、分布式锁的 Redis 实现、ZK 实现等等各类文章不计其数，然而只要简单一搜就会发现，大多数文章都在教大家 Redis 分布式锁的原理和实现方法，但却没有几篇会写什么实现是好的实现，是适合用于生产环境，高效而考虑全面的实现。这将是本文讨论的内容。

### 分布式锁的要求
本节简单阐述分布式锁的基本要求，通常满足下述要求便可以说是比较完整的实现了。

1. 操作原子性
    - 与本地锁一样，加锁的过程必须保证原子性，否则失去锁的意义
    - Redis 的单线程模型帮我们解决了大部分原子性的问题，但仍然要考虑客户端代码中的原子性问题。
2. 可重入性
    - 分布式锁一样要考虑可重入的问题
    - Redis 通常能解决实例间的可重入问题，那么实例内线程间的可重入怎么办？
3. 效率
    - Redis 作为通过 TCP 通信的外部服务，网络延迟不可避免，因此相比本地锁操作时间更久
    - 分布式锁获取失败的通常做法是线程休眠一段时间
    - 如何才能尽可能减少不必要的通信与休眠？
